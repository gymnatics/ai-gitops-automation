- op: add
  path: /spec/resourceHealthChecks/-
  value:
    group: maistra.io
    kind: ServiceMeshControlPlane
    check: |
      health_status = {}
      if obj.status ~= nil then
        if obj.status.conditions ~= nil then
          for i, condition in pairs(obj.status.conditions) do
            if condition.type == "Ready" and condition.status == "True" then
              health_status.status = "Healthy"
              health_status.message = "Service Mesh Control Plane is ready"
              return health_status
            elseif condition.type == "Reconciled" and condition.status == "True" then
              health_status.status = "Progressing"
              health_status.message = "Service Mesh Control Plane is reconciling"
            end
          end
        end
        if obj.status.readiness ~= nil then
          if obj.status.readiness.components ~= nil then
            pending_count = 0
            ready_count = 0
            for name, component in pairs(obj.status.readiness.components) do
              if component == "ComponentReady" then
                ready_count = ready_count + 1
              else
                pending_count = pending_count + 1
              end
            end
            if pending_count > 0 then
              health_status.status = "Progressing"
              health_status.message = string.format("%d components ready, %d components pending", ready_count, pending_count)
            else
              health_status.status = "Healthy"
              health_status.message = "All components are ready"
            end
            return health_status
          end
        end
      end
      health_status.status = "Progressing"
      health_status.message = "Service Mesh Control Plane is initializing"
      return health_status
